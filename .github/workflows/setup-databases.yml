name: Setup Databases

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Database action'
        required: true
        default: 'up'
        type: choice
        options:
        - up
        - down
        - restart

jobs:
  setup-databases:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.HETZNER_SSH_PRIVATE_KEY }}

    - name: Add Hetzner server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.HETZNER_SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Deploy docker-compose files to server
      run: |
        scp docker-compose.db.yml root@${{ secrets.HETZNER_SERVER_IP }}:/tmp/
        scp .env.example root@${{ secrets.HETZNER_SERVER_IP }}:/tmp/

    - name: Setup environment on server
      run: |
        ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /tmp
          # Copy example env if .env doesn't exist
          if [ ! -f .env ]; then
            cp .env.example .env
          fi

          # Set database configuration using existing SSV_ variables
          echo "SSV_DB_USER=${{ secrets.SSV_DB_USER }}" >> .env
          echo "SSV_DB_PASSWORD=${{ secrets.SSV_DB_PASSWORD }}" >> .env
          echo "SSV_DB_DATABASE=${{ vars.SSV_DB_DATABASE }}" >> .env
          echo "SSV_DB_PORT=${{ vars.SSV_DB_PORT }}" >> .env
          echo "SSV_REDIS_PORT=${{ vars.SSV_REDIS_PORT }}" >> .env
          echo "SSV_REDIS_PASS=${{ secrets.SSV_REDIS_PASS }}" >> .env
        EOF


    - name: Start databases
      if: github.event.inputs.action == 'up' || github.event.inputs.action == ''
      run: |
        ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /tmp
          docker compose -f docker-compose.db.yml up -d

          # Wait for databases to be ready
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c "until docker compose -f docker-compose.db.yml exec -T postgres pg_isready -U ${{ secrets.SSV_DB_USER }}; do sleep 2; done"

          echo "Waiting for Redis to be ready..."
          timeout 60 bash -c "until docker compose -f docker-compose.db.yml exec -T redis redis-cli -a ${{ secrets.SSV_REDIS_PASS }} ping; do sleep 2; done"

          echo "✅ Databases are ready!"
        EOF

    - name: Stop databases
      if: github.event.inputs.action == 'down'
      run: |
        ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /tmp
          docker compose -f docker-compose.db.yml down -v
          echo "✅ Databases stopped and volumes removed!"
        EOF

    - name: Restart databases
      if: github.event.inputs.action == 'restart'
      run: |
        ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /tmp
          docker compose -f docker-compose.db.yml restart

          # Wait for databases to be ready after restart
          echo "Waiting for PostgreSQL to be ready..."
          timeout 60 bash -c "until docker compose -f docker-compose.db.yml exec -T postgres pg_isready -U ${{ secrets.SSV_DB_USER }}; do sleep 2; done"

          echo "Waiting for Redis to be ready..."
          timeout 60 bash -c "until docker compose -f docker-compose.db.yml exec -T redis redis-cli -a ${{ secrets.SSV_REDIS_PASS }} ping; do sleep 2; done"

          echo "✅ Databases restarted!"
        EOF

    - name: Show database status
      run: |
        ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /tmp
          echo "=== Database Container Status ==="
          docker compose -f docker-compose.db.yml ps

          echo -e "\n=== PostgreSQL Connection Test ==="
          docker compose -f docker-compose.db.yml exec -T postgres psql -U ${{ secrets.SSV_DB_USER }} -d ${{ vars.SSV_DB_DATABASE }} -c "SELECT version();" || echo "❌ PostgreSQL connection failed"

          echo -e "\n=== Redis Connection Test ==="
          docker compose -f docker-compose.db.yml exec -T redis redis-cli -a ${{ secrets.SSV_REDIS_PASS }} ping || echo "❌ Redis connection failed"
        EOF

    - name: Show logs on failure
      if: failure()
      run: |
        ssh root@${{ secrets.HETZNER_SERVER_IP }} << 'EOF'
          cd /tmp
          echo "=== PostgreSQL Logs ==="
          docker compose -f docker-compose.db.yml logs postgres

          echo -e "\n=== Redis Logs ==="
          docker compose -f docker-compose.db.yml logs redis
        EOF